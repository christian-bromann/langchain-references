# Build IR Workflow
#
# Builds IR artifacts for all LangChain ecosystem projects.
# Uses a matrix strategy to build each package in parallel for maximum speed.
#
# Workflow steps:
# 1. Generate build matrix from config files
# 2. Build each package in parallel and upload to Vercel Blob
# 3. Update project package indexes
#
# Triggers:
# - Manual dispatch with optional project/language filters
# - Scheduled daily builds
# - Push to main (workflow, config, extractor, or schema changes)

name: Build IR

on:
  # Manual trigger with optional filters
  workflow_dispatch:
    inputs:
      project:
        description: "Project to build (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - langchain
          - langgraph
          - langsmith
          - deepagent
          - integrations
      language:
        description: "Language to build (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - python
          - typescript
          - java
          - go
      with_versions:
        description: "Include version history tracking"
        required: false
        type: boolean
        default: true
      full_version_rebuild:
        description: "Force full rebuild of version history (ignore existing changelogs)"
        required: false
        type: boolean
        default: false

  # Trigger on upstream releases (via repository_dispatch)
  repository_dispatch:
    types: [upstream-release]

  # Build on push to main (workflow, extractor, or config changes)
  push:
    branches:
      - main
    paths:
      - ".github/workflows/build-ir.yml"
      - "configs/**"
      - "packages/build-pipeline/**"
      - "packages/extractor-*/**"
      - "packages/ir-schema/**"

# Ensure only one build runs at a time per ref
concurrency:
  group: build-ir-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Step 1: Generate build matrix
  # ============================================================================
  matrix:
    name: Generate Build Matrix
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.generate.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate package-level matrix
        id: generate
        run: |
          # Build the list of packages from config files
          PROJECT="${{ github.event.inputs.project }}"
          LANGUAGE="${{ github.event.inputs.language }}"

          # Generate matrix entries from config files
          PACKAGES="[]"

          for config_file in configs/*-python.json configs/*-typescript.json configs/*-java.json configs/*-go.json; do
            # Skip if no files match
            [ -f "$config_file" ] || continue

            # Skip schema file and version files
            [[ "$config_file" == *"config-schema"* ]] && continue
            [[ "$config_file" == *"-versions.json" ]] && continue

            config_name=$(basename "$config_file")
            file_project=$(echo "$config_name" | sed 's/-\(python\|typescript\|java\|go\)\.json$//')
            file_language=$(echo "$config_name" | sed 's/.*-\(python\|typescript\|java\|go\)\.json$/\1/')

            # Apply project filter
            if [ -n "$PROJECT" ] && [ "$file_project" != "$PROJECT" ]; then
              continue
            fi

            # Apply language filter
            if [ -n "$LANGUAGE" ] && [ "$file_language" != "$LANGUAGE" ]; then
              continue
            fi

            # Extract packages from config file
            packages_in_config=$(jq -r '.packages[].name' "$config_file")

            for pkg in $packages_in_config; do
              entry=$(jq -n \
                --arg project "$file_project" \
                --arg language "$file_language" \
                --arg config "$config_name" \
                --arg package "$pkg" \
                '{project: $project, language: $language, config: $config, package: $package}')
              PACKAGES=$(echo "$PACKAGES" | jq -c ". + [$entry]")
            done
          done

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Building $(echo "$PACKAGES" | jq length) packages in parallel:"
          echo "$PACKAGES" | jq -r '.[] | "  - \(.project)/\(.language)/\(.package)"'

  # ============================================================================
  # Step 2: Build each package
  # ============================================================================
  build:
    name: ${{ matrix.package }} (${{ matrix.language }})
    needs: [matrix]
    if: ${{ needs.matrix.outputs.packages != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.packages) }}

    outputs:
      compiled: ${{ steps.check-result.outputs.compiled }}

    env:
      BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          echo "After cleanup:"
          df -h /

      - name: Setup Python (for Python builds)
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python extractor (for Python builds)
        if: matrix.language == 'python'
        run: |
          cd packages/extractor-python
          pip install -e .

      - name: Setup Java (for Java builds)
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Go (for Go builds)
        if: matrix.language == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Build and Upload IR for ${{ matrix.package }}
        id: build
        run: |
          # Always force build to ensure config changes (like subpages) are reflected
          FLAGS="--force"

          # Add versioning flag if enabled (default: true)
          if [ "${{ inputs.with_versions }}" != "false" ]; then
            FLAGS="$FLAGS --with-versions"
          fi

          # Add full version rebuild flag if requested (rebuilds all changelogs)
          if [ "${{ inputs.full_version_rebuild }}" == "true" ]; then
            FLAGS="$FLAGS --full"
          fi

          # Run via tsx directly with package filter for parallel execution
          # Package-level builds upload directly and update their own pointers
          npx tsx packages/build-pipeline/src/commands/build-ir.ts \
            --config ./configs/${{ matrix.config }} \
            --package "${{ matrix.package }}" \
            $FLAGS

          echo "compiled=true" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BLOB_URL: ${{ secrets.BLOB_URL }}
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}

      - name: Check result
        id: check-result
        run: |
          if [ "${{ steps.build.outputs.compiled }}" == "true" ]; then
            echo "compiled=true" >> $GITHUB_OUTPUT
          else
            echo "compiled=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare artifact name
        if: steps.build.outputs.compiled == 'true'
        id: artifact
        run: |
          SAFE_NAME=$(echo "${{ matrix.package }}" | sed 's/@//g' | sed 's/\//-/g' | sed 's/\./-/g')
          echo "name=ir-${{ matrix.project }}-${{ matrix.language }}-${SAFE_NAME}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        if: steps.build.outputs.compiled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: |
            ir-output/
            !ir-output/latest-*
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # Step 3: Update project indexes (after all package builds complete)
  # ============================================================================
  # With package-level builds, each package uploads directly during its build job.
  # This job just regenerates the project package indexes to include all packages.
  update-indexes:
    name: Update Project Indexes
    needs: [matrix, build]
    runs-on: ubuntu-latest
    # Run if build succeeded (even if some were skipped)
    if: ${{ !cancelled() && needs.build.result == 'success' }}

    env:
      BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update project package indexes
        run: |
          echo "ðŸ”„ Regenerating project package indexes..."

          # Determine which projects/languages were built
          PROJECT="${{ github.event.inputs.project }}"
          LANGUAGE="${{ github.event.inputs.language }}"

          if [ -n "$PROJECT" ] && [ -n "$LANGUAGE" ]; then
            # Specific project/language
            echo "Updating index for $PROJECT-$LANGUAGE"
            npx tsx packages/build-pipeline/src/commands/update-indexes.ts \
              --project "$PROJECT" \
              --language "$LANGUAGE"
          elif [ -n "$PROJECT" ]; then
            # All languages for a project
            echo "Updating indexes for $PROJECT (all languages)"
            npx tsx packages/build-pipeline/src/commands/update-indexes.ts \
              --project "$PROJECT"
          elif [ -n "$LANGUAGE" ]; then
            # All projects for a language
            echo "Updating indexes for $LANGUAGE (all projects)"
            npx tsx packages/build-pipeline/src/commands/update-indexes.ts \
              --language "$LANGUAGE"
          else
            # All projects and languages
            echo "Updating all project indexes"
            npx tsx packages/build-pipeline/src/commands/update-indexes.ts --all
          fi
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          BLOB_URL: ${{ secrets.BLOB_URL }}

      - name: Report completion
        run: |
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Package-level builds have been uploaded and project indexes updated." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Summary job
  # ============================================================================
  summary:
    name: Build Summary
    needs: [matrix, build, update-indexes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Matrix | ${{ needs.matrix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Upload | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Update Indexes | ${{ needs.update-indexes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… All package builds completed successfully!" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "skipped" ]; then
            echo "â­ï¸ Builds were skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some builds failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
