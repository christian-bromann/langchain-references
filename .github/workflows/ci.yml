# CI Workflow
#
# Runs lint, type checking, unit tests, and e2e tests on pull requests and pushes.
# On success, triggers the Performance Tests workflow.

name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint

      - name: Run format check
        run: pnpm fmt:check

      - name: Type check
        run: pnpm typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test
        env:
          NEXT_TELEMETRY_DISABLED: 1

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Pull IR data
        run: pnpm pull-ir
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          BLOB_URL: ${{ secrets.BLOB_URL }}

      - name: Start server and run e2e tests
        run: |
          # Create .env.local for the dev server to use the local IR server
          echo "BLOB_URL=http://localhost:3001" > .env.local
          
          # Start the dev server (includes static IR server) in the background
          pnpm dev &
          SERVER_PID=$!

          # Wait for both servers to be ready
          echo "Waiting for servers to start..."
          for i in {1..60}; do
            WEB_READY=false
            IR_READY=false
            
            if curl -s http://localhost:3000 > /dev/null 2>&1; then
              WEB_READY=true
            fi
            if curl -s http://localhost:3001 > /dev/null 2>&1; then
              IR_READY=true
            fi
            
            if [ "$WEB_READY" = true ] && [ "$IR_READY" = true ]; then
              echo "Both servers are ready!"
              break
            fi
            
            if [ $i -eq 60 ]; then
              echo "Servers failed to start (web: $WEB_READY, ir: $IR_READY)"
              exit 1
            fi
            sleep 1
          done

          # Run e2e tests (agent tests will be skipped without API keys)
          pnpm --filter @langchain/reference-web test:e2e

          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
        env:
          NEXT_TELEMETRY_DISABLED: 1
          MCP_TEST_URL: http://localhost:3000
          BLOB_URL: http://localhost:3001
          # Optional: enables agent-based e2e tests (tests are skipped if not set)
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  perf-tests:
    name: Performance Tests
    needs: [lint, unit-tests, e2e-tests]
    if: success()
    uses: ./.github/workflows/perf-tests.yml
